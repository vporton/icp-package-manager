#!/usr/bin/make -f

SHELL=/bin/bash

NETWORK = local
export DFX_NETWORK = $(NETWORK)
export MOPS_ENV = $(NETWORK)
USER = $(shell dfx identity get-principal)
# DEPLOY_FLAGS.bookmark = --argument "rec { bootstrapper = \"$$()\""; }"
DEPLOY_FLAGS.bootstrapper_data = --argument "principal \"$(USER)\""

.PHONY: deploy
deploy:

# Don't use dfx.json dependency, because package_manager is not to be installed.
# example_frontend is used here to deploy an asset canister.
build@bootstrapper_frontend: generate@example_frontend generate@package_manager generate@main_indirect generate@simple_indirect generate@bookmark generate@battery generate@bootstrapper

include deps.$(NETWORK).mk
Makefile: deps.$(NETWORK).mk
deps.$(NETWORK).mk: dfx.json
	dfx rules --network $(NETWORK) -o $@

.PHONY: deps
deps:
	dfx rules --network $(NETWORK) -o deps.$(NETWORK).mk

# INIT_BLOB = $(shell echo 'encode(record {})' | ic-repl-linux64)
INIT_BLOB = blob "\44\49\44\4c\01\6c\00\01\00"

.PHONY: deploy
deploy: deploy@bootstrapper_frontend deploy-self@package_manager_frontend deploy@example_frontend \
	generate@example_frontend generate@package_manager_frontend deploy-backend

.PHONY: deploy-backend
deploy-backend: prepare build@battery build@main_indirect build@package_manager build@simple_indirect deploy@repository deploy@bookmark generate@battery \
  deploy@internet_identity deploy@pst generate@pst init

.PHONY: prepare
prepare:
# ifeq "$(NETWORK)" "local"
# #	dfx extension install nns
# 	dfx nns install
# endif

.PHONY: init
init:
	-dfx canister call bookmark init "record { bootstrapper = principal \"`dfx canister id bootstrapper`\" }"
	-dfx ledger fabricate-cycles --t 20000 --canister repository
	-dfx canister call repository init "()"
	-dfx canister call bootstrapper_data setOwner "(principal \"`dfx canister id bootstrapper`\")"

.PHONY: deploy-work
deploy-work: prepare deploy
	npx tsx scripts/prepare-work.ts

.PHONY: prepare
prepare:
ifeq "$(NETWORK)" "local"
	-dfx nns install --ledger-accounts `dfx ledger account-id`
endif

.PHONY: deploy-test
deploy-test: deploy-work \
  deploy@upgrade_example_backend1_v1 deploy@upgrade_example_backend2_v1 \
  deploy@upgrade_example_backend2_v2 deploy@upgrade_example_backend3_v2
	npx tsx scripts/prepare-test.ts

DEPLOY_FLAGS.bookmark = --argument "principal \"$(USER)\""
# icrc2, icrc3 and icrc4 are left null so that pst.mo uses its builtâ€‘in defaults.
DEPLOY_FLAGS.pst = --argument 'opt record { \
  icrc1 = opt record { \
    name = opt "IC Pack Profit Share"; \
    symbol = opt "ICPACK"; \
    logo = ?"data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4KPCEtLSBHZW5lcmF0b3I6IEFkb2JlIElsbHVzdHJhdG9yIDI3LjMuMSwgU1ZHIEV4cG9ydCBQbHVnLUluIC4gU1ZHIFZlcnNpb246IDYuMDAgQnVpbGQgMCkgIC0tPgo8c3ZnIHZlcnNpb249IjEuMSIgaWQ9IkxheWVyXzEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHg9IjBweCIgeT0iMHB4IgoJIHZpZXdCb3g9IjAgMCAyNjYgMjU0IiBzdHlsZT0iZW5hYmxlLWJhY2tncm91bmQ6bmV3IDAgMCAyNjYgMjU0OyIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSI+CjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+Cgkuc3Qwe2ZpbGw6bm9uZTt9Cgkuc3Qxe2ZpbGw6dXJsKCNTVkdJRF8xXyk7fQoJLnN0MntmaWxsOnVybCgjU1ZHSURfMDAwMDAxNzA5Njg2MDc4Mjk5Mjc3NjA1MTAwMDAwMDg4Njk4NzI1MzU5MDg5NzM5NjdfKTt9Cgkuc3Qze2ZpbGw6IzE5MUYyNTt9Cgkuc3Q0e2ZpbGw6dXJsKCNTVkdJRF8wMDAwMDEzNzEwOTYzNTE4NzE1NjYxMjA4MDAwMDAwODAyNTE5NzIyNzQ3NTEwODUzN18pO30KCS5zdDV7ZmlsbDp1cmwoI1NWR0lEXzAwMDAwMDE0NjA2ODAyOTE3MDY0NjQ0ODEwMDAwMDE0MjczODA1MjkwNTI5NDA4OTE3Xyk7fQoJLnN0NntmaWxsOnVybCgjU1ZHSURfMDAwMDAwNjcyMjYxOTc5ODc3NzU1MTQzMjAwMDAwMTAxODk5NTkyNjgwNTYxMTgxNThfKTt9Cgkuc3Q3e2ZpbGw6dXJsKCNTVkdJRF8wMDAwMDA3NzI4OTIzNTg2NzE5NjQxMTQxMDAwMDAxMjA4MTg4MzM4NTAzNzQyMDk2NV8pO30KCS5zdDh7ZmlsbDp1cmwoI1NWR0lEXzAwMDAwMTQxNDM4OTY4MjgwOTA5NjYwMTQwMDAwMDEzNjYxNzc1MDQwOTAxOTQ2NTQzXyk7fQoJLnN0OXtmaWxsOnVybCgjU1ZHSURfMDAwMDAxMTU0OTcxMjQ3MDI3MjA0Nzk2NDAwMDAwMDY4MDczNzc1NjM0ODMxNTI4MjRfKTt9Cgkuc3QxMHtmaWxsOnVybCgjU1ZHSURfMDAwMDAwNTYzODU5NTg5MTYyNDY0NTQ3MTAwMDAwMTU0Mjc2OTAwNzMyNzA0NzA3OTdfKTt9Cgkuc3QxMXtmaWxsOnVybCgjU1ZHSURfMDAwMDAxMTQwNjM4NDEyMDE4NTQ2MTIyMjAwMDAwMTQ1OTg5NDEwOTA5NDgxNTY4MjFfKTt9Cgkuc3QxMntmaWxsOnVybCgjU1ZHSURfMDAwMDAxNjUyMzcwNjEwMDQzNzkwNzQ3OTAwMDAwMDMwNjU4MzMzMzMwMTg2NjgxOTRfKTt9Cjwvc3R5bGU+CjxyZWN0IGNsYXNzPSJzdDAiIHdpZHRoPSIyNjYiIGhlaWdodD0iMjU0Ii8+CjxnPgoJPGc+CgkJPGxpbmVhckdyYWRpZW50IGlkPSJTVkdJRF8xXyIgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIHgxPSIxMjMuMTg2MyIgeTE9IjE4NS45MzA5IiB4Mj0iMjA3LjM3NzIiIHkyPSI1Ny4zMDU5Ij4KCQkJPHN0b3AgIG9mZnNldD0iMS4wNDkzNjFlLTAzIiBzdHlsZT0ic3RvcC1jb2xvcjojRjI1QTI0Ii8+CgkJCTxzdG9wICBvZmZzZXQ9IjEiIHN0eWxlPSJzdG9wLWNvbG9yOiNGQkIwM0EiLz4KCQk8L2xpbmVhckdyYWRpZW50PgoJCTxwYXRoIGNsYXNzPSJzdDEiIGQ9Ik0xNzkuMTMsODAuNThsLTAuODMsMC43N2wtMSwwLjdjLTMuNDEsMi4zOS0xMC42Myw5LjcyLTIwLjAxLDIxLjI3Yy0xLjk2LDIuNDItNC4wMiw1LjAxLTYuMTUsNy43OQoJCQlsLTAuMTIsMC4xNWMtMi41MiwzLjEzLTI0LjY5LDMwLjUxLTM1LjMsMzguNDNjLTEuOTcsMS42OS00LjEsMy4xMy02LjI5LDQuMzdMMTU1Ljg4LDE3MWw0NC45Mi01MC43NUwxNzkuMTMsODAuNTh6Ii8+CgkJCgkJCTxsaW5lYXJHcmFkaWVudCBpZD0iU1ZHSURfMDAwMDAxMTMzMTkyMjc2NTA3MjQzMjQ0MjAwMDAwMDIwMjY3NDU5ODU0ODczODcwNjlfIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeDE9IjYzLjgxOSIgeTE9IjEzNi44MTM3IiB4Mj0iMTQ2Ljk0NDUiIHkyPSI5LjgxNjQiPgoJCQk8c3RvcCAgb2Zmc2V0PSIxLjA0OTM2MWUtMDMiIHN0eWxlPSJzdG9wLWNvbG9yOiNGMjVBMjQiLz4KCQkJPHN0b3AgIG9mZnNldD0iMSIgc3R5bGU9InN0b3AtY29sb3I6I0ZCQjAzQSIvPgoJCTwvbGluZWFyR3JhZGllbnQ+CgkJPHBhdGggc3R5bGU9ImZpbGw6dXJsKCNTVkdJRF8wMDAwMDExMzMxOTIyNzY1MDcyNDMyNDQyMDAwMDAwMjAyNjc0NTk4NTQ4NzM4NzA2OV8pOyIgZD0iTTEyMi4xOCw4OC42NWwzLjEtMy42OAoJCQljMS4yOC0xLjYzLDIuNjUtMy4zMyw0LjA3LTUuMDhjNy4xOC04LjgyLDE1Ljg5LTE4LjY5LDIzLjUtMjQuOTdsLTQ2LjkzLTE4LjY2TDYxLDg3bDE5LjQxLDM4LjA5CgkJCWM0LjQzLTAuMjcsMTAuMTMtMS43NCwxMS41Ni0zLjA2bDAuODktMC44M2wxLTAuN2M0LjMtMy4wMSwxNC45MS0xNC4xNSwyOC4wMy0zMS41MUwxMjIuMTgsODguNjV6Ii8+Cgk8L2c+Cgk8Zz4KCQk8cGF0aCBjbGFzcz0ic3QzIiBkPSJNNTcuMzIsMTc3LjU4aDYuMDh2MzIuNzFoLTYuMDhWMTc3LjU4eiIvPgoJCTxwYXRoIGNsYXNzPSJzdDMiIGQ9Ik02Ny41NSwxOTMuOTRjMC05Ljc3LDcuNDgtMTYuODMsMTcuNTMtMTYuODNjNS4zMywwLDkuOTEsMS45MiwxMi45NSw1LjQ3bC0zLjkzLDMuNjkKCQkJYy0yLjM4LTIuNTctNS4zMy0zLjgzLTguNzQtMy44M2MtNi43OCwwLTExLjY4LDQuNzctMTEuNjgsMTEuNXM0LjkxLDExLjUsMTEuNjgsMTEuNWMzLjQxLDAsNi4zNi0xLjI2LDguNzQtMy44OGwzLjkzLDMuNzQKCQkJYy0zLjA0LDMuNTUtNy42Miw1LjQ3LTEyLjk5LDUuNDdDNzUuMDMsMjEwLjc3LDY3LjU1LDIwMy43MSw2Ny41NSwxOTMuOTR6Ii8+CgkJPHBhdGggY2xhc3M9InN0MyIgZD0iTTEzOS40OCwxODkuMjJjMCw3LjItNS4zMywxMS42NC0xMy45MywxMS42NGgtNy4zOHY5LjQ0aC02LjA4di0zMi43MWgxMy40NgoJCQlDMTM0LjE1LDE3Ny41OCwxMzkuNDgsMTgxLjk4LDEzOS40OCwxODkuMjJ6IE0xMzMuMzYsMTg5LjIyYzAtNC4xMS0yLjc2LTYuNS04LjA4LTYuNWgtNy4xdjEyLjk5aDcuMQoJCQlDMTMwLjYsMTk1LjcyLDEzMy4zNiwxOTMuMzMsMTMzLjM2LDE4OS4yMnoiLz4KCQk8cGF0aCBjbGFzcz0ic3QzIiBkPSJNMTYzLjMyLDE5NS42N3YxNC42M2gtNS41MXYtMy4wNGMtMS40LDIuMTUtNC4xMSwzLjM2LTcuODUsMy4zNmMtNS43LDAtOS4zLTMuMTMtOS4zLTcuNDgKCQkJYzAtNC4xNiwyLjgtNy40MywxMC4zOC03LjQzaDYuNDV2LTAuMzdjMC0zLjQxLTIuMDYtNS40Mi02LjIyLTUuNDJjLTIuOCwwLTUuNywwLjkzLTcuNTcsMi40OGwtMi4yOS00LjI1CgkJCWMyLjY2LTIuMDYsNi41NC0zLjA4LDEwLjU2LTMuMDhDMTU5LjE2LDE4NS4wNiwxNjMuMzIsMTg4LjQ3LDE2My4zMiwxOTUuNjd6IE0xNTcuNDgsMjAyLjQ5di0yLjloLTYuMDMKCQkJYy0zLjk3LDAtNS4wNSwxLjUtNS4wNSwzLjMyYzAsMi4xLDEuNzgsMy40Niw0Ljc3LDMuNDZDMTU0LjAyLDIwNi4zNywxNTYuNDksMjA1LjA2LDE1Ny40OCwyMDIuNDl6Ii8+CgkJPHBhdGggY2xhc3M9InN0MyIgZD0iTTE2Ni42NCwxOTcuODJjMC03LjQ4LDUuNjEtMTIuNzYsMTMuNTEtMTIuNzZjNC44NiwwLDguNzQsMi4wMSwxMC42NSw1LjhsLTQuNDksMi42MgoJCQljLTEuNS0yLjM4LTMuNzQtMy40Ni02LjIyLTMuNDZjLTQuMywwLTcuNTcsMi45OS03LjU3LDcuODFjMCw0Ljg2LDMuMjcsNy44LDcuNTcsNy44YzIuNDgsMCw0LjcyLTEuMDcsNi4yMi0zLjQ2bDQuNDksMi42MgoJCQljLTEuOTIsMy43NC01Ljc5LDUuODQtMTAuNjUsNS44NEMxNzIuMjUsMjEwLjYzLDE2Ni42NCwyMDUuMywxNjYuNjQsMTk3LjgyeiIvPgoJCTxwYXRoIGNsYXNzPSJzdDMiIGQ9Ik0yMDMuNDcsMTk5LjZsLTQuMzUsNC4xMXY2LjU5aC01Ljg0di0zNC42OGg1Ljg0djIwLjk0bDEyLjEtMTEuMjJoNy4wMWwtMTAuNDIsMTAuNDdsMTEuNCwxNC40OWgtNy4xCgkJCUwyMDMuNDcsMTk5LjZ6Ii8+Cgk8L2c+CgkKCQk8bGluZWFyR3JhZGllbnQgaWQ9IlNWR0lEXzAwMDAwMTUyMjI0MTE5NzA3MDI1MTI2ODEwMDAwMDE3OTk3NjM5OTQxMTAzMDU4NTc2XyIgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIHgxPSIzMjcuMDU3NyIgeTE9IjQxNi4wMTQ3IiB4Mj0iMzM0LjQ3MiIgeTI9IjMzNy44Mjc5IiBncmFkaWVudFRyYW5zZm9ybT0ibWF0cml4KDAuNzQ4NyAwLjY2MjkgLTAuNjYyOSAwLjc0ODcgNTguMjg1NyAtMzg3LjQxODkpIj4KCQk8c3RvcCAgb2Zmc2V0PSIwIiBzdHlsZT0ic3RvcC1jb2xvcjojODQyQ0YwIi8+CgkJPHN0b3AgIG9mZnNldD0iMSIgc3R5bGU9InN0b3AtY29sb3I6IzI4QUJFMyIvPgoJPC9saW5lYXJHcmFkaWVudD4KCTxwYXRoIHN0eWxlPSJmaWxsOnVybCgjU1ZHSURfMDAwMDAxNTIyMjQxMTk3MDcwMjUxMjY4MTAwMDAwMTc5OTc2Mzk5NDExMDMwNTg1NzZfKTsiIGQ9Ik00Ni4xNiwxMDIuOTUKCQljLTAuMS0xMS41OSw2LjAxLTIxLjgxLDE1LjIyLTI3LjVsMjEuMjQtMjMuOTljLTMuMzItMC4yMi01LjQzLTAuMDUtNS40OC0wLjA1Yy0yOC4wMSwwLjU0LTUwLjUxLDIzLjYxLTUwLjI3LDUxLjY5CgkJYzAuMjQsMjguMjcsMjMuNDMsNTEuMDgsNTEuNyw1MC44NGwtMC4xNi0xOS4yOUM2MC43NywxMzQuODEsNDYuMzEsMTIwLjU5LDQ2LjE2LDEwMi45NXoiLz4KCQoJCTxsaW5lYXJHcmFkaWVudCBpZD0iU1ZHSURfMDAwMDAxMjQxMTk5Njg2MzA5NDU2NzM4NjAwMDAwMTI5MzQ2NTYzNTMyNDg0NjU1ODJfIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeDE9IjIwNS43MDQiIHkxPSIxNjkuMDQzNSIgeDI9IjE4OC4wNTI0IiB5Mj0iMTEwLjQ3MjIiIGdyYWRpZW50VHJhbnNmb3JtPSJtYXRyaXgoMC45OTUyIDAuMDk3OCAtMC4wOTc4IDAuOTk1MiAtMjUuOTQ5IC0xNS4wNzQzKSI+CgkJPHN0b3AgIG9mZnNldD0iMS4wNDkzNjFlLTAzIiBzdHlsZT0ic3RvcC1jb2xvcjojRjI1QTI0Ii8+CgkJPHN0b3AgIG9mZnNldD0iMSIgc3R5bGU9InN0b3AtY29sb3I6I0ZCQjAzQSIvPgoJPC9saW5lYXJHcmFkaWVudD4KCTxwYXRoIHN0eWxlPSJmaWxsOnVybCgjU1ZHSURfMDAwMDAxMjQxMTk5Njg2MzA5NDU2NzM4NjAwMDAwMTI5MzQ2NTYzNTMyNDg0NjU1ODJfKTsiIGQ9Ik0yMDAuOCwxMjAuMjVsLTQzLjUyLTE2Ljk0CgkJYy0xLjk2LDIuNDItNC4wMiw1LjAxLTYuMTUsNy43OWwtMC4xMiwwLjE1Yy0yLjUyLDMuMTMtMjQuNjksMzAuNTEtMzUuMywzOC40M2MtMS45NywxLjY5LTQuMSwzLjEzLTYuMjksNC4zN0wxNTUuODgsMTcxCgkJTDIwMC44LDEyMC4yNXoiLz4KCQoJCTxsaW5lYXJHcmFkaWVudCBpZD0iU1ZHSURfMDAwMDAwNDQxNjY0MDA0MjcwMTg3NjgzODAwMDAwMTU3OTQ4Mjg3NDE4MTQxNzM4NDdfIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeDE9IjIwOS4zNjg1IiB5MT0iMTE2Ljk2NzgiIHgyPSIyMzguMjUzIiB5Mj0iNzIuODM4OCIgZ3JhZGllbnRUcmFuc2Zvcm09Im1hdHJpeCgwLjk5NTIgMC4wOTc4IC0wLjA5NzggMC45OTUyIC0yNS45NDkgLTE1LjA3NDMpIj4KCQk8c3RvcCAgb2Zmc2V0PSIxLjA0OTM2MWUtMDMiIHN0eWxlPSJzdG9wLWNvbG9yOiNGMjVBMjQiLz4KCQk8c3RvcCAgb2Zmc2V0PSIxIiBzdHlsZT0ic3RvcC1jb2xvcjojRkJCMDNBIi8+Cgk8L2xpbmVhckdyYWRpZW50PgoJPHBhdGggc3R5bGU9ImZpbGw6dXJsKCNTVkdJRF8wMDAwMDA0NDE2NjQwMDQyNzAxODc2ODM4MDAwMDAxNTc5NDgyODc0MTgxNDE3Mzg0N18pOyIgZD0iTTE3Ny4yOSw4Mi4wNAoJCWMtMy40MSwyLjM5LTEwLjYzLDkuNzItMjAuMDEsMjEuMjdsNDMuNTIsMTYuOTRsLTIxLjY4LTM5LjY4bC0wLjgzLDAuNzdMMTc3LjI5LDgyLjA0eiIvPgoJCgkJPGxpbmVhckdyYWRpZW50IGlkPSJTVkdJRF8wMDAwMDE0NTczNjUyNjgxODIzMTk3MjYzMDAwMDAxNzQzNDk0OTM1NDUwODE1MTk5NF8iIGdyYWRpZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIiB4MT0iMzMwLjM0NzQiIHkxPSIzODAuMjA2OCIgeDI9IjM0Ni42NDQ2IiB5Mj0iMjc5LjkxNjMiIGdyYWRpZW50VHJhbnNmb3JtPSJtYXRyaXgoMC43NDg3IDAuNjYyOSAtMC42NjI5IDAuNzQ4NyA1OC4yODU3IC0zODcuNDE4OSkiPgoJCTxzdG9wICBvZmZzZXQ9IjEuMDQ5MzYxZS0wMyIgc3R5bGU9InN0b3AtY29sb3I6I0YyNUEyNCIvPgoJCTxzdG9wICBvZmZzZXQ9IjEiIHN0eWxlPSJzdG9wLWNvbG9yOiNGQkIwM0EiLz4KCTwvbGluZWFyR3JhZGllbnQ+Cgk8cGF0aCBzdHlsZT0iZmlsbDp1cmwoI1NWR0lEXzAwMDAwMTQ1NzM2NTI2ODE4MjMxOTcyNjMwMDAwMDE3NDM0OTQ5MzU0NTA4MTUxOTk0Xyk7IiBkPSJNOTIuODYsMTIxLjIxbDEtMC43CgkJYzQuMy0zLjAxLDE0LjkxLTE0LjE1LDI4LjAzLTMxLjUxbDAuMjgtMC4zNWwzLjEtMy42OGMxLjI4LTEuNjMsMi42NS0zLjMzLDQuMDctNS4wOGwtMjMuNDMtNDMuNjRMNjEsODdsMTkuNDEsMzguMDkKCQljNC40My0wLjI3LDEwLjEzLTEuNzQsMTEuNTYtMy4wNkw5Mi44NiwxMjEuMjF6Ii8+CgkKCQk8bGluZWFyR3JhZGllbnQgaWQ9IlNWR0lEXzAwMDAwMTI2Mjk0MjExOTAyMDkwMDk0NTQwMDAwMDAxNjYwMzcxNzEyODkxNDY4MjIyXyIgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIHgxPSIxNDIuMjc3NyIgeTE9IjczLjA1MzkiIHgyPSIxNzEuMTYyMiIgeTI9IjI4LjkyNDkiIGdyYWRpZW50VHJhbnNmb3JtPSJtYXRyaXgoMC45OTUyIDAuMDk3OCAtMC4wOTc4IDAuOTk1MiAtMjUuOTQ5IC0xNS4wNzQzKSI+CgkJPHN0b3AgIG9mZnNldD0iMS4wNDkzNjFlLTAzIiBzdHlsZT0ic3RvcC1jb2xvcjojRjI1QTI0Ii8+CgkJPHN0b3AgIG9mZnNldD0iMSIgc3R5bGU9InN0b3AtY29sb3I6I0ZCQjAzQSIvPgoJPC9saW5lYXJHcmFkaWVudD4KCTxwYXRoIHN0eWxlPSJmaWxsOnVybCgjU1ZHSURfMDAwMDAxMjYyOTQyMTE5MDIwOTAwOTQ1NDAwMDAwMDE2NjAzNzE3MTI4OTE0NjgyMjJfKTsiIGQ9Ik0xNTIuODUsNTQuOTJsLTQ2LjkzLTE4LjY2bDIzLjQzLDQzLjY0CgkJQzEzNi41NCw3MS4wNywxNDUuMjUsNjEuMiwxNTIuODUsNTQuOTJ6Ii8+CgkKCQk8bGluZWFyR3JhZGllbnQgaWQ9IlNWR0lEXzAwMDAwMTI1NTgxODkwNzkyODQxMjc4MTUwMDAwMDA3NDM2NjA5OTE1MjY0MTMwOTkzXyIgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIHgxPSIyNzguODQ0NiIgeTE9IjM0OC4yODkzIiB4Mj0iMzgyLjQ1NjIiIHkyPSIzMTguNjg1OSIgZ3JhZGllbnRUcmFuc2Zvcm09Im1hdHJpeCgwLjc0ODcgMC42NjI5IC0wLjY2MjkgMC43NDg3IDU4LjI4NTcgLTM4Ny40MTg5KSI+CgkJPHN0b3AgIG9mZnNldD0iMCIgc3R5bGU9InN0b3AtY29sb3I6IzI3QUFFMSIvPgoJCTxzdG9wICBvZmZzZXQ9IjEiIHN0eWxlPSJzdG9wLWNvbG9yOiM1MjI2ODUiLz4KCTwvbGluZWFyR3JhZGllbnQ+Cgk8cGF0aCBzdHlsZT0iZmlsbDp1cmwoI1NWR0lEXzAwMDAwMTI1NTgxODkwNzkyODQxMjc4MTUwMDAwMDA3NDM2NjA5OTE1MjY0MTMwOTkzXyk7IiBkPSJNNzguNTksMTUzLjkxYzAuMywwLDAuODctMC4wMSwxLjY3LTAuMDUKCQljNS4xOS0wLjI1LDE5Ljg1LTEuNywyOS4zLTkuOThjOS44NS03LjEzLDMzLjk4LTM3LjExLDMzLjk4LTM3LjExYzExLjUyLTE0Ljk5LDIyLjI3LTI2LjgxLDI4LjA1LTMwLjg1bDAuNTMtMC4zN2wwLjQ3LTAuNDQKCQljNC4zMy0zLjk4LDE0LjMyLTUuMzQsMTguNTMtNS4zN2MwLjAxLDAsMC4wMiwwLDAuMDMsMGwtMC4xMy0xOS4yOWMtMC4wMSwwLTAuMDMsMC0wLjA0LDBjLTIuMjIsMC4wMi0yMC4wNywwLjQ3LTMwLjk3LDEwLjAzCgkJQzE1MC45OSw2NywxMzksODEuMjksMTMxLjE0LDkxLjI4bC0zLjE5LDMuNzljLTEyLjEsMTYtMjMuODYsMjkuMDktMjkuOTYsMzMuMzZsLTAuNTMsMC4zN2wtMC40OCwwLjQ0CgkJYy00LjMzLDMuOTgtMTQuMzIsNS4zNC0xOC41Myw1LjM3Yy0wLjAxLDAtMC4wMiwwLTAuMDMsMGMwLDAtMjMuMzktMC45NC0zNC40My0xNC41OGMtMjIuMzEtMzUuMTUsMC4xNi01NS43MSwwLjE2LTU1LjcxCgkJYzAsMC0xMC43Myw4LjQ0LTE1LjIxLDIzLjkxYy00LjYyLDE1LjkyLTQuNywzOS4yMiwyMS40MSw1OC4wM0M2Mi44OCwxNTUsNzguNTksMTUzLjkxLDc4LjU5LDE1My45MXoiLz4KCQoJCTxsaW5lYXJHcmFkaWVudCBpZD0iU1ZHSURfMDAwMDAxMTI2MzQ2NTY1MTE3OTQyNTYwMjAwMDAwMTIwNTYyNjIzNDk1NTYwNzEzNTlfIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeDE9IjQ2MC44NDUxIiB5MT0iMjY3Ljg3OTkiIHgyPSI0MDcuMDkxNyIgeTI9IjI3Ni40NDkzIiBncmFkaWVudFRyYW5zZm9ybT0ibWF0cml4KDAuNzQ4NyAwLjY2MjkgLTAuNjYyOSAwLjc0ODcgNTguMjg1NyAtMzg3LjQxODkpIj4KCQk8c3RvcCAgb2Zmc2V0PSIwIiBzdHlsZT0ic3RvcC1jb2xvcjojRjc5NDFEIi8+CgkJPHN0b3AgIG9mZnNldD0iMSIgc3R5bGU9InN0b3AtY29sb3I6I0VGNDEzNiIvPgoJPC9saW5lYXJHcmFkaWVudD4KCTxwYXRoIHN0eWxlPSJmaWxsOnVybCgjU1ZHSURfMDAwMDAxMTI2MzQ2NTY1MTE3OTQyNTYwMjAwMDAwMTIwNTYyNjIzNDk1NTYwNzEzNTlfKTsiIGQ9Ik0yNDIuODMsMTAxLjMxCgkJYy0wLjI0LTI4LjI3LTIzLjQzLTUxLjA4LTUxLjctNTAuODRjMCwwLTE2LjgyLTAuNDMtMjguOTksOC4zMmMtMTAuNzIsNi45LTI3LjQxLDI4LjAxLTI3LjQxLDI4LjAxYzAuNTEsMCwyNC42My03LjU4LDQxLjc2LTE0LjEKCQljOC40Ni0zLjIyLDE2Ljg0LTIuODksMTcuMDktMi44OGMxNi41OCwxLjA0LDI5LjgyLDE0Ljc5LDI5Ljk2LDMxLjY1YzAuMTIsMTQuNTUtOS41NSwyNi45NC0yMi44NCwzMC45MWwtOC44LDkuOTVsMC4wOSwxMC42OQoJCUMyMjAuMjUsMTUyLjc3LDI0My4wNiwxMjkuNTgsMjQyLjgzLDEwMS4zMXoiLz4KCQoJCTxyYWRpYWxHcmFkaWVudCBpZD0iU1ZHSURfMDAwMDAxNDE0NTU4OTUxMDczMjAxNDMwOTAwMDAwMTgzOTczNzIxMzQ1MDQ5NjkzODJfIiBjeD0iNDQ1LjA3OTgiIGN5PSIyNzMuOTAxMyIgcj0iMzkuODU0NiIgZ3JhZGllbnRUcmFuc2Zvcm09Im1hdHJpeCgwLjc0ODcgMC42NjI5IC0wLjY2MjkgMC43NDg3IDU4LjI4NTcgLTM4Ny40MTg5KSIgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiPgoJCTxzdG9wICBvZmZzZXQ9IjAiIHN0eWxlPSJzdG9wLWNvbG9yOiNGNzk0MUQiLz4KCQk8c3RvcCAgb2Zmc2V0PSIxIiBzdHlsZT0ic3RvcC1jb2xvcjojRUY0MTM2Ii8+Cgk8L3JhZGlhbEdyYWRpZW50PgoJPHBhdGggc3R5bGU9ImZpbGw6dXJsKCNTVkdJRF8wMDAwMDE0MTQ1NTg5NTEwNzMyMDE0MzA5MDAwMDAxODM5NzM3MjEzNDUwNDk2OTM4Ml8pOyIgZD0iTTIzNy4yLDc4LjAxCgkJYy03LjE4LTE0LjQ5LTE5LjE2LTIwLjE2LTE5LjE2LTIwLjE2Yy0wLjIyLDAsMjcuNTEsMTYuODEsMTQuMiw1MC41Yy01LjI0LDExLjUtMTguNzEsMTguMzQtMjUuODUsMjEuNzEKCQljLTEuODEsMC44Ni0zLjY1LDEuNS01LjQxLDEuOTlsLTE3LjkzLDIwLjI1YzQuNDgsMC42Myw3Ljg5LDAuNjYsOC43OCwwLjY1YzAuMDEsMCwwLjAzLDAsMC4wNCwwYzAsMCwxNi42OSwxLjQyLDMzLjI4LTExLjk5CgkJQzI0OC4zMiwxMTguNDYsMjQ0Ljc5LDkzLjMzLDIzNy4yLDc4LjAxeiIvPgoJCgkJPGxpbmVhckdyYWRpZW50IGlkPSJTVkdJRF8wMDAwMDAyMTgzODY1NjkxMDQ2NTc5NDkxMDAwMDAwMjE3NDcyNDA2NzQ1NzYwODU4Ml8iIGdyYWRpZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIiB4MT0iMzk3LjMyMTQiIHkxPSIyNTEuMjE5OCIgeDI9IjM2OC4yMzc1IiB5Mj0iMzMxLjU0NyIgZ3JhZGllbnRUcmFuc2Zvcm09Im1hdHJpeCgwLjc0ODcgMC42NjI5IC0wLjY2MjkgMC43NDg3IDU4LjI4NTcgLTM4Ny40MTg5KSI+CgkJPHN0b3AgIG9mZnNldD0iMCIgc3R5bGU9InN0b3AtY29sb3I6I0VGNDEzNiIvPgoJCTxzdG9wICBvZmZzZXQ9IjEiIHN0eWxlPSJzdG9wLWNvbG9yOiM5MjI3OEYiLz4KCTwvbGluZWFyR3JhZGllbnQ+Cgk8cGF0aCBzdHlsZT0iZmlsbDp1cmwoI1NWR0lEXzAwMDAwMDIxODM4NjU2OTEwNDY1Nzk0OTEwMDAwMDAyMTc0NzI0MDY3NDU3NjA4NTgyXyk7IiBkPSJNMTkzLjU3LDY5LjgyCgkJYzAuNTIsMC4wMywxLjA0LDAuMDgsMS41NSwwLjE0bC0wLjE2LTE5LjM4Yy0xLjI3LTAuMDgtMi41NS0wLjEyLTMuODQtMC4xMWMwLDAtMTYuODMtMC42My0yOC45OSw4LjEyCgkJYy0xNC4yOSwxMC44Ny0yNy40MSwyOC4yMS0yNy40MSwyOC4yMWMtNi4yLDcuMTQtMjIuODYsMzAuMjUtMzMuMzIsMzguODdjLTEyLjYsMTIuNjYtMzIuNyw3LjU4LTMyLjcsNy41OAoJCWMwLjIsMCwxOS44NywxMC4xNCw1MS0xMS40NGMyNC45NS0xNi42MSw0Ni40NC00NS4xNyw1Ni43Ny00OS4xMUMxODQuOTQsNjkuNDgsMTkzLjMyLDY5LjgsMTkzLjU3LDY5LjgyeiIvPgo8L2c+Cjwvc3ZnPgo=";
    decimals = 8; \
    fee = opt variant { Fixed = 10000 }; \
    minting_account = opt record { \
      owner = principal "$(shell dfx canister id pst)"; \
      subaccount = null \
    }; \
    initial_balances = vec { \
      record { \
        record { \
          owner = principal "$(USER)"; \
          subaccount = null \
        }; \
        13333600000000 \
      } \
    }; \
    max_supply = opt 16667000000000; \
    min_burn_amount = opt 100000 \
  }; \
  icrc2 = null; \
  icrc3 = null; \
  icrc4 = null \
}'

.PHONY: docs
docs: docs/out/CNAME docs/out/md/icpack docs/out/html/icpack docs/out/index.html docs/out/internet-computer-icp-logo.svg

.PHONY: deploy-docs
deploy-docs: docs
	cleanup() { \
	  test "$$TMPDIR" != '' && rm -rf "$$TMPDIR"; \
	} && \
	trap "cleanup" EXIT && \
	TMPDIR=`mktemp -d` && \
	(cd $$TMPDIR && git clone git@github.com:vporton/icpack-docs.git) && \
	rm -rf $$TMPDIR/icpack-docs/* && \
	cp -a docs/out/* $$TMPDIR/icpack-docs/ && \
	cd $$TMPDIR/icpack-docs/ && git add -A && git commit -m "Update docs" && git push

docs/out/%: docs/src/%
	cp -f $< $@

.PHONY: docs/out/md/icpack
docs/out/md/icpack:
	rm -rf $@
	`dfx cache show`/mo-doc --source src --output $@ --format plain

.PHONY: docs/out/html/icpack
docs/out/html/icpack:
	rm -rf $@
	`dfx cache show`/mo-doc --source src --output $@ --format html

build@example_frontend: generate@example_backend